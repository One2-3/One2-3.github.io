{{- /* layouts/partials/widgets/slider.html  */ -}}
{{- $p := .widget -}}
{{- $params := $p.Params -}}
{{- $content := (index $params "content" | default dict) -}}
{{- $slides := (index $content "slides" | default (slice)) -}}
{{- $design := (index $params "design" | default dict) -}}
{{- $height := (index $design "slide_height" | default "70vh") -}}
{{- $autoplay := (index $design "autoplay_ms" | default 5000) -}}
{{- $id := (index $params "id" | default "top") -}}

{{- $minh := printf "min-h-[%s]" $height -}}
{{- $idHash := md5 $p.Path -}}
{{- $cid := printf "hb-slider-%s" $idHash -}}

<section id="{{ $id }}" class="w-full">
  {{- if lt (len $slides) 1 -}}
    <div class="text-red-600 py-12">슬라이드가 없습니다 ({{ $p.Path }})</div>
  {{- else -}}
    <style>
      /* 가로 스크롤바 숨김 */
      .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
      .no-scrollbar::-webkit-scrollbar{ display:none; }
      /* 인디케이터 바 */
      .hb-dot{ width:24px; height:2px; border-radius:9999px; background:rgba(255,255,255,.35); opacity:.45; transition:opacity .2s ease; }
      .hb-dot.is-active{ opacity:.95; background:rgba(255,255,255,.95); }
      /* 텍스트 화살표 버튼 (원/배경 없음) */
      .hb-arrow{ font-size:28px; line-height:1; padding:6px 10px; color:#fff; opacity:.65; }
      .hb-arrow:hover{ opacity:1; }
      .hb-arrow:focus{ outline:none; }
    </style>

    <div id="{{ $cid }}" data-autoplay="{{ $autoplay }}"
         class="relative no-scrollbar w-full overflow-x-auto flex items-stretch snap-x snap-mandatory {{ $minh }}"
         tabindex="0" aria-roledescription="carousel">

      {{- range $s := $slides -}}
        {{- $bg := (index $s "background" | default dict) -}}
        {{- $imgObj := (index $bg "image" | default dict) -}}
        {{- $img := (index $imgObj "filename" | default "") -}}
        {{- $url := cond (hasPrefix $img "/") $img (printf "/%s" $img) -}}

        <!-- 폭 고정: shrink-0 + min-w-full -->
        <div class="hb-slide shrink-0 min-w-full snap-start relative" aria-hidden="true">
          {{- if $img -}}
            <div class="absolute inset-0 z-0 bg-center bg-cover {{ $minh }}"
                 style='background-image:url("{{ $url | relURL }}")'></div>
          {{- else -}}
            <div class="absolute inset-0 z-0 bg-center bg-cover {{ $minh }}"></div>
          {{- end }}
          <div class="absolute inset-0 z-10 bg-black/40"></div>

          <div class="relative z-20 max-w-5xl mx-auto px-6 py-16 flex flex-col items-center justify-center text-center {{ $minh }}">
            {{- with (index $s "title") -}}
              <h1 class="text-4xl font-bold mb-4">{{ . }}</h1>
            {{- end -}}
            {{- with (index $s "content") -}}
              <div class="text-lg opacity-90">{{ . | markdownify }}</div>
            {{- end -}}
          </div>
        </div>
      {{- end -}}

      <!-- 인디케이터 (사진 안쪽 하단) -->
      <div class="hb-dots absolute bottom-4 left-0 right-0 z-30 flex justify-center gap-2 pointer-events-auto"></div>

      <!-- 좌우 텍스트 화살표 버튼 -->
      <button type="button" class="hb-prev hb-arrow absolute left-3 top-1/2 -translate-y-1/2 z-40" aria-label="Previous slide">&lt;</button>
      <button type="button" class="hb-next hb-arrow absolute right-3 top-1/2 -translate-y-1/2 z-40" aria-label="Next slide">&gt;</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
      var c = document.getElementById('{{ $cid }}');
      if (!c) return;

      var delayAttr = c.getAttribute('data-autoplay');
      var delay = parseInt(delayAttr, 10);
      if (isNaN(delay) || delay <= 0) delay = 5000;

      var i = 0;
      var timer = null;
      var dotsWrap = c.querySelector('.hb-dots');
      var btnPrev = c.querySelector('.hb-prev');
      var btnNext = c.querySelector('.hb-next');

      function slides(){ return c.querySelectorAll('.hb-slide'); }

      function goTo(idx){
        var s = slides();
        if (!s.length) return;
        i = (idx + s.length) % s.length;
        c.scrollTo({ left: s[i].offsetLeft, behavior: 'smooth' });
        paint();
      }

      function step(){ goTo(i + 1); }
      function start(){ if (!timer) timer = setInterval(step, delay); }
      function stop(){ if (timer){ clearInterval(timer); timer = null; } }

      function makeDots(){
        var s = slides();
        dotsWrap.innerHTML = '';
        for (var k=0; k<s.length; k++){
          var b = document.createElement('button');
          b.type = 'button';
          b.className = 'hb-dot';
          (function(idx){
            b.addEventListener('click', function(){
              stop(); goTo(idx); start();
            });
          })(k);
          dotsWrap.appendChild(b);
        }
      }

      function paint(){
        var s = slides();
        if (dotsWrap.children.length !== s.length) makeDots();
        var dots = dotsWrap.querySelectorAll('.hb-dot');
        for (var k=0; k<dots.length; k++){
          dots[k].classList.toggle('is-active', k === i);
        }
        // aria 동기화
        for (var j=0; j<s.length; j++){
          s[j].setAttribute('aria-hidden', j === i ? 'false' : 'true');
        }
      }

      // ▶︎ 고정 느낌 제거용: IntersectionObserver로 현재 슬라이드 정확 추적
      // 컨테이너를 root로, 0.6 이상 보이면 현재로 간주
      var io;
      try {
        io = new IntersectionObserver(function(entries){
          var maxRatio = 0, idx = i;
          entries.forEach(function(en){
            if (en.intersectionRatio > maxRatio) {
              maxRatio = en.intersectionRatio;
              var list = Array.prototype.slice.call(slides());
              idx = list.indexOf(en.target);
            }
          });
          if (idx !== i && maxRatio >= 0.6){
            i = idx; paint();
          }
        }, { root: c, threshold: [0, .6, 1] });

        slides().forEach(function(el){ io.observe(el); });
      } catch(e) {
        // IE 등 구형 브라우저 fallback: 스크롤 거리로 계산
        c.addEventListener('scroll', function(){
          var s = slides();
          var min = Infinity, idx = i;
          for (var k=0; k<s.length; k++){
            var d = Math.abs(c.scrollLeft - s[k].offsetLeft);
            if (d < min){ min = d; idx = k; }
          }
          if (idx !== i){ i = idx; paint(); }
        }, { passive:true });
      }

      // 버튼/호버/터치/키보드
      btnPrev.addEventListener('click', function(){ stop(); goTo(i-1); start(); });
      btnNext.addEventListener('click', function(){ stop(); goTo(i+1); start(); });
      c.addEventListener('mouseenter', stop);
      c.addEventListener('mouseleave', start);
      c.addEventListener('touchstart', stop, { passive:true });
      c.addEventListener('touchend', start, { passive:true });
      c.addEventListener('keydown', function(e){
        if (e.key === 'ArrowLeft'){ stop(); goTo(i-1); start(); }
        else if (e.key === 'ArrowRight'){ stop(); goTo(i+1); start(); }
      });

      // 리사이즈 시 위치 재정렬(고정 느낌 방지)
      window.addEventListener('resize', function(){
        var s = slides(); if (!s.length) return;
        c.scrollTo({ left: s[i].offsetLeft, behavior: 'auto' });
      });

      makeDots();
      paint();
      start();
    });
    </script>
  {{- end -}}
</section>
