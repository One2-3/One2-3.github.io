{{- /* layouts/partials/widgets/slider.html */ -}}
{{- $p := .widget -}}
{{- $params := $p.Params -}}
{{- $content := (index $params "content" | default dict) -}}
{{- $slides := (index $content "slides" | default (slice)) -}}
{{- $design := (index $params "design" | default dict) -}}
{{- $height := (index $design "slide_height" | default "70vh") -}}
{{- $autoplay := (index $design "autoplay_ms" | default 5000) -}}
{{- $id := (index $params "id" | default "top") -}}

{{- /* Tailwind arbitrary value utility, e.g. min-h-[70vh] */ -}}
{{- $minh := printf "min-h-[%s]" $height -}}

{{- /* unique container id for this widget instance */ -}}
{{- $idHash := md5 $p.Path -}}
{{- $cid := printf "hb-slider-%s" $idHash -}}

<section id="{{ $id }}" class="w-full">
  {{- if lt (len $slides) 1 -}}
    <div class="text-red-600 py-12">슬라이드가 없습니다 ({{ $p.Path }})</div>
  {{- else -}}
    <div id="{{ $cid }}" data-autoplay="{{ $autoplay }}" class="relative w-full overflow-x-auto flex snap-x snap-mandatory {{ $minh }}">
      {{- range $s := $slides -}}
        {{- $bg := (index $s "background" | default dict) -}}
        {{- $imgObj := (index $bg "image" | default dict) -}}
        {{- $img := (index $imgObj "filename" | default "") -}}
        {{- $url := cond (hasPrefix $img "/") $img (printf "/%s" $img) -}}

        <div class="hb-slide min-w-full snap-start relative">
          {{- if $img -}}
            <div class="absolute inset-0 bg-center bg-cover {{ $minh }}"
                 style='background-image:url("{{ $url | relURL }}")'></div>
          {{- else -}}
            <div class="absolute inset-0 bg-center bg-cover {{ $minh }}"></div>
          {{- end }}
          <div class="absolute inset-0 bg-black/40"></div>

          <div class="relative z-10 max-w-5xl mx-auto px-6 py-16 flex flex-col items-center justify-center text-center {{ $minh }}">
            {{- with (index $s "title") -}}
              <h1 class="text-4xl font-bold mb-4">{{ . }}</h1>
            {{- end -}}
            {{- with (index $s "content") -}}
              <div class="text-lg opacity-90">{{ . | markdownify }}</div>
            {{- end -}}
          </div>
        </div>
      {{- end -}}
    </div>
    <div id="{{ $cid }}-dots" class="mt-3 flex justify-center gap-2"></div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var c = document.getElementById('{{ $cid }}');
        if (!c) return;
      
        var delayAttr = c.getAttribute('data-autoplay');
        var delay = parseInt(delayAttr, 10);
        if (isNaN(delay) || delay <= 0) delay = 5000;
      
        var i = 0;
        var timer = null;
        var dotsWrap = document.getElementById('{{ $cid }}-dots');
      
        function slides() { return c.querySelectorAll('.hb-slide'); }
      
        function makeDots() {
          var s = slides();
          dotsWrap.innerHTML = '';
          for (var k = 0; k < s.length; k++) {
            var b = document.createElement('button');
            // "___" 느낌의 바(언더스코어) 스타일
            b.className = 'hb-dot w-6 h-0.5 bg-white/40 dark:bg-white/40 rounded-full transition-opacity';
            b.type = 'button';
            b.setAttribute('aria-label', 'Go to slide ' + (k + 1));
            (function(idx){
              b.addEventListener('click', function(){
                stop();
                i = idx;
                c.scrollTo({ left: slides()[i].offsetLeft, behavior: 'smooth' });
                paint();
                start();
              });
            })(k);
            dotsWrap.appendChild(b);
          }
        }
      
        function paint() {
          var s = slides();
          var dots = dotsWrap.querySelectorAll('.hb-dot');
          // 안전장치
          if (dots.length !== s.length) makeDots();
          dots = dotsWrap.querySelectorAll('.hb-dot');
          for (var k = 0; k < dots.length; k++) {
            // 활성화: 더 진한 바
            dots[k].classList.toggle('opacity-90', k === i);
            dots[k].classList.toggle('opacity-40', k !== i);
            // 기본 클래스에는 bg-white/40가 들어가 있으므로 불필요한 재지정은 하지 않음
          }
        }
      
        function step() {
          var s = slides();
          if (s.length < 2) return;
          i = (i + 1) % s.length;
          c.scrollTo({ left: s[i].offsetLeft, behavior: 'smooth' });
          paint();
        }
      
        function start() {
          if (!timer) timer = setInterval(step, delay);
        }
        function stop() {
          if (timer) { clearInterval(timer); timer = null; }
        }
      
        // 사용자가 스크롤해서 슬라이드가 바뀐 경우에도 인디케이터 갱신
        c.addEventListener('scroll', function(){
          var s = slides();
          var minDist = Infinity, idx = 0;
          for (var k = 0; k < s.length; k++) {
            var dist = Math.abs(c.scrollLeft - s[k].offsetLeft);
            if (dist < minDist) { minDist = dist; idx = k; }
          }
          if (idx !== i) { i = idx; paint(); }
        }, { passive: true });
      
        c.addEventListener('mouseenter', stop);
        c.addEventListener('mouseleave', start);
        c.addEventListener('touchstart', stop, { passive: true });
        c.addEventListener('touchend', start, { passive: true });
      
        makeDots();
        paint();
        start();
      });
      </script>
      
      
  {{- end -}}
</section>
