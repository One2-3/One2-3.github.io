{{/* 언어와 섹션 안정적으로 계산하기 */}}
{{- $parts := split .RelPermalink "/" -}}        {{/* ["", "ko", "about", ""] 형태 */}}
{{- $lang := (index $parts 1) | default "ko" -}}
{{- $sectionName := (index $parts 2) -}}
{{- if or .IsHome (not $sectionName) -}}
  {{- $sectionName = "home" -}}
{{- end -}}

{{- $sec := site.GetPage (printf "/%s/%s" $lang $sectionName) -}}

<section class="container mx-auto px-6">
  {{- if not $sec -}}
    <div class="text-red-600 py-12">
      content/{{ $lang }}/{{ $sectionName }}/index.md 를 찾을 수 없습니다.
    </div>
  {{- else -}}
    {{/* 브랜치 섹션(_index.md)은 .Pages, 리프 번들(index.md)은 .Resources 사용 */}}
    {{- $all := slice -}}
    {{- if $sec.IsBranch -}}
      {{- $all = $sec.Pages -}}
    {{- else -}}
      {{- $all = ($sec.Resources.Match "**.md") | default (slice) -}}
    {{- end -}}

    {{/* index 제외 + widget 파라미터가 있는 파일만 필터 */}}
    {{- $widgets := where (where $all "File.BaseFileName" "!=" "index") "Params.widget" "!=" nil | default (slice) -}}

    {{- if eq (len $widgets) 0 -}}
      <div class="text-amber-600 py-12">
        {{ $sectionName }} 폴더에 위젯(.md) 파일이 없습니다.
      </div>
    {{- else -}}
      {{- $sorted := sort $widgets "Params.weight" "asc" -}}
      {{- range $p := $sorted -}}
        {{- $w := lower (printf "%v" (index $p.Params "widget")) -}}
        {{- $wfile := replace $w "." "_" -}}  {{/* about.avatar → about_avatar */}}
        {{- $partial := printf "widgets/%s.html" $wfile -}}
        {{- if templates.Exists (printf "partials/%s" $partial) -}}
          {{ partial $partial (dict "page" . "widget" $p) }}
        {{- else -}}
          <div class="py-8 text-amber-600">알 수 없는 위젯: {{ $w }}</div>
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
</section>
