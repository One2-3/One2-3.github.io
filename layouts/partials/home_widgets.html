{{/* 현재 콘텍스트에서 섹션 페이지($sec) 안전하게 얻기 */}}
{{- $sec := . -}}

{{- if .IsHome -}}
  {{- /* 홈: content/<lang>/home/index.md (leaf bundle) */ -}}
  {{- $sec = site.GetPage (printf "/%s/home" .Lang) -}}
{{- else -}}
  {{- /* 섹션 페이지(about/_index.md 등)라면 그대로 사용, 일반 콘텐츠면 상위 섹션으로 */ -}}
  {{- if eq .Kind "section" -}}
    {{- $sec = . -}}
  {{- else -}}
    {{- $sec = .CurrentSection -}}
  {{- end -}}
{{- end -}}

<section class="container mx-auto px-6">

  {{- if not $sec -}}
    <div class="text-red-600 py-12">
      위젯 섹션을 찾을 수 없습니다. (현재 페이지 기준 섹션 탐색 실패)
    </div>
  {{- else -}}

    {{/* 브랜치 섹션(_index.md)은 .Pages, 리프 번들(index.md)은 .Resources 사용 */}}
    {{- $all := slice -}}
    {{- if $sec.IsBranch -}}
      {{- $all = $sec.Pages -}}
    {{- else -}}
      {{- $all = ($sec.Resources.Match "**.md") | default (slice) -}}
    {{- end -}}

    {{/* index 제외 + widget 파라미터가 있는 파일만 */}}
    {{- $widgets := where (where $all "File.BaseFileName" "!=" "index") "Params.widget" "!=" nil | default (slice) -}}

    {{- if eq (len $widgets) 0 -}}
      <div class="text-amber-600 py-12">
        이 섹션에 렌더할 위젯(.md)이 없습니다.
      </div>
    {{- else -}}
      {{- $sorted := sort $widgets "Params.weight" "asc" -}}
      {{- range $p := $sorted -}}
        {{- $w := lower (printf "%v" (index $p.Params "widget")) -}}
        {{- $wfile := replace $w "." "_" -}}  {{/* about.avatar → about_avatar */}}
        {{- $partial := printf "widgets/%s.html" $wfile -}}
        {{- if templates.Exists (printf "partials/%s" $partial) -}}
          {{ partial $partial (dict "page" . "widget" $p) }}
        {{- else -}}
          <div class="py-8 text-amber-600">알 수 없는 위젯: {{ $w }}</div>
        {{- end -}}
      {{- end -}}
    {{- end -}}

  {{- end -}}
</section>
